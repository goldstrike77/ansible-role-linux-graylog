---
- name: Generate root password
  shell: "echo -n {{ graylog_root_password }} | shasum -a 256|awk '{ print $0 }'|cut -d ' ' -f 1"
  register: graylog_root_password_sha2
  changed_when: false
  failed_when: false
  no_log: true

- name: Creating Graylog folder
  file:
    dest: '{{ graylog_path }}/graylog'
    state: directory
    owner: graylog
    group: graylog
    mode: 0755

- name: Configure kernel parameters
  sysctl:
    name: '{{ item.variable }}'
    value: '{{ item.value }}'
    state: present
    reload: yes
    sysctl_set: yes
    sysctl_file: /etc/sysctl.d/20-sysctl.conf
  loop: "{{ graylog_kernel_parameters|flatten(levels=1) }}"

- name: Graylog http certificate file transfer
  copy:
    src: 'ssl/'
    dest: '/etc/graylog/server/ssl'
    owner: 'root'
    group: 'root'
    mode: 0644
  no_log: true
  register: cert_update

- name: Graylog plugin file transfer
  copy:
    src: 'plugin/'
    dest: '/usr/share/graylog-server/plugin'
    owner: 'root'
    group: 'root'
    mode: 0644
  no_log: true
  register: plugin_update

- name: Graylog system configuration
  template:
    src: 'graylog-server.j2'
    dest: '/etc/sysconfig/graylog-server'
    owner: root
    group: root
    mode: 0644
  register: sys_update

- name: Graylog server configuration
  lineinfile:
    state: 'present'
    dest: '/etc/graylog/server/server.conf'
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  loop: "{{ graylog_conf_parameter|flatten(levels=1) }}"
  register: conf_update
